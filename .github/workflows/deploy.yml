name: Production Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      skip_tests:
        description: 'Skip tests (emergency deployment only)'
        required: false
        default: false
        type: boolean

concurrency:
  group: deploy-${{ github.event.inputs.environment || 'production' }}
  cancel-in-progress: false

env:
  BUN_VERSION: '1.1.12'
  NODE_ENV: production

jobs:
  pre-deployment-checks:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ !github.event.inputs.skip_tests }}
    
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      commit-sha: ${{ steps.check.outputs.commit-sha }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run critical tests
        run: |
          echo "Running critical test suite..."
          bun run test -- --run --reporter=verbose
          
      - name: Security pre-check
        run: bun audit --audit-level=high

      - name: Deployment readiness check
        id: check
        run: |
          echo "should-deploy=true" >> $GITHUB_OUTPUT
          echo "commit-sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "‚úÖ Pre-deployment checks passed"

  build-production:
    name: Build Production Assets
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [pre-deployment-checks]
    if: always() && (needs.pre-deployment-checks.result == 'success' || needs.pre-deployment-checks.result == 'skipped')

    outputs:
      build-artifact: ${{ steps.upload.outputs.artifact-id }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate version
        id: version
        run: |
          VERSION=$(date +%Y%m%d)-${GITHUB_SHA:0:7}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Configure environment
        run: |
          echo "VITE_APP_VERSION=${{ steps.version.outputs.version }}" >> apps/pwa/.env.production
          echo "VITE_APP_BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> apps/pwa/.env.production
          echo "VITE_APP_COMMIT_SHA=${{ github.sha }}" >> apps/pwa/.env.production

      - name: Build production bundle
        run: |
          echo "Building production assets..."
          bun run build
          
          # Verify critical files exist
          if [ ! -f "apps/pwa/dist/index.html" ]; then
            echo "ERROR: index.html not found"
            exit 1
          fi
          
          # Generate build manifest
          echo "{
            \"version\": \"${{ steps.version.outputs.version }}\",
            \"buildTime\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"commitSha\": \"${{ github.sha }}\",
            \"environment\": \"${{ github.event.inputs.environment || 'production' }}\"
          }" > apps/pwa/dist/build-manifest.json

      - name: Optimize build
        run: |
          echo "=== Build Size Analysis ==="
          du -sh apps/pwa/dist/*
          
          # Compress assets for better performance
          find apps/pwa/dist -name "*.js" -o -name "*.css" -o -name "*.html" | xargs gzip -k

      - name: Upload build artifact
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: production-build-${{ steps.version.outputs.version }}
          path: apps/pwa/dist/
          retention-days: 30

  deploy-to-vercel:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build-production]
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.preview-url || steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: production-build-${{ needs.build-production.outputs.version }}
          path: apps/pwa/dist/

      - name: Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: apps/pwa/dist
          vercel-args: ${{ github.event.inputs.environment == 'production' && '--prod' || '' }}

  deploy-to-netlify:
    name: Deploy to Netlify (Backup)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build-production]
    if: ${{ github.event.inputs.environment != 'staging' }}
    environment: 
      name: netlify-${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: production-build-${{ needs.build-production.outputs.version }}
          path: apps/pwa/dist/

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: apps/pwa/dist
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy v${{ needs.build-production.outputs.version }}"
          enable-pull-request-comment: false
          enable-commit-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  health-check:
    name: Post-deployment Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [deploy-to-vercel]

    steps:
      - name: Wait for deployment propagation
        run: sleep 30

      - name: Health check - Basic connectivity
        run: |
          DEPLOY_URL="${{ needs.deploy-to-vercel.outputs.preview-url || 'https://ninja-clan-wars.vercel.app' }}"
          echo "Checking health of: $DEPLOY_URL"
          
          # Basic connectivity test
          curl -f -s -I "$DEPLOY_URL" || exit 1
          echo "‚úÖ Basic connectivity check passed"

      - name: Health check - Application loads
        run: |
          DEPLOY_URL="${{ needs.deploy-to-vercel.outputs.preview-url || 'https://ninja-clan-wars.vercel.app' }}"
          
          # Check if main app loads
          RESPONSE=$(curl -f -s "$DEPLOY_URL")
          if echo "$RESPONSE" | grep -q "ninja-clan-wars"; then
            echo "‚úÖ Application content check passed"
          else
            echo "‚ùå Application content check failed"
            exit 1
          fi

      - name: Performance check
        run: |
          DEPLOY_URL="${{ needs.deploy-to-vercel.outputs.preview-url || 'https://ninja-clan-wars.vercel.app' }}"
          
          # Basic performance check
          START_TIME=$(date +%s%N)
          curl -f -s "$DEPLOY_URL" > /dev/null
          END_TIME=$(date +%s%N)
          
          RESPONSE_TIME=$(( (END_TIME - START_TIME) / 1000000 ))
          echo "Response time: ${RESPONSE_TIME}ms"
          
          if [ $RESPONSE_TIME -lt 3000 ]; then
            echo "‚úÖ Performance check passed"
          else
            echo "‚ö†Ô∏è Performance check warning: slow response time"
          fi

  rollback-plan:
    name: Prepare Rollback Plan
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [build-production, deploy-to-vercel]
    if: failure()

    steps:
      - name: Prepare rollback information
        run: |
          echo "=== ROLLBACK INFORMATION ==="
          echo "Failed deployment version: ${{ needs.build-production.outputs.version }}"
          echo "Failed commit: ${{ github.sha }}"
          echo "Previous stable deployment should be restored"
          echo ""
          echo "To rollback manually:"
          echo "1. Check Vercel dashboard for previous deployment"
          echo "2. Or redeploy previous commit"
          echo "3. Monitor health checks after rollback"

      - name: Notify ops team
        uses: 8398a7/action-slack@v3
        if: env.SLACK_WEBHOOK_URL != ''
        with:
          status: failure
          text: |
            üö® PRODUCTION DEPLOYMENT FAILED üö®
            Version: ${{ needs.build-production.outputs.version }}
            Commit: ${{ github.sha }}
            Rollback may be required.
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  success-notification:
    name: Deployment Success Notification
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [build-production, deploy-to-vercel, health-check]
    if: success()

    steps:
      - name: Generate deployment summary
        run: |
          echo "=== DEPLOYMENT SUCCESSFUL ==="
          echo "Version: ${{ needs.build-production.outputs.version }}"
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "URL: ${{ needs.deploy-to-vercel.outputs.preview-url || 'https://ninja-clan-wars.vercel.app' }}"
          echo "Commit: ${{ github.sha }}"
          echo "Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      - name: Notify success
        uses: 8398a7/action-slack@v3
        if: env.SLACK_WEBHOOK_URL != ''
        with:
          status: success
          text: |
            ‚úÖ PRODUCTION DEPLOYMENT SUCCESSFUL
            Version: ${{ needs.build-production.outputs.version }}
            URL: ${{ needs.deploy-to-vercel.outputs.preview-url || 'https://ninja-clan-wars.vercel.app' }}
            Environment: ${{ github.event.inputs.environment || 'production' }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}