name: Preview Deployment

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to deploy'
        required: true
        type: string

concurrency:
  group: preview-${{ github.event.pull_request.number || github.event.inputs.pr_number }}
  cancel-in-progress: true

env:
  BUN_VERSION: '1.1.12'
  NODE_ENV: preview

jobs:
  quick-validation:
    name: Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 8
    
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      pr-number: ${{ steps.pr.outputs.number }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR info
        id: pr
        run: |
          if [ "${{ github.event.pull_request.number }}" != "" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Quick linting
        run: bun run lint

      - name: Quick build test
        run: |
          echo "Testing build process..."
          bun run build
          
          if [ ! -f "apps/pwa/dist/index.html" ]; then
            echo "âŒ Build failed - no output"
            exit 1
          fi
          echo "âœ… Build test passed"

      - name: Deployment check
        id: check
        run: |
          echo "should-deploy=true" >> $GITHUB_OUTPUT
          echo "âœ… Ready for preview deployment"

  build-preview:
    name: Build Preview
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: [quick-validation]
    if: needs.quick-validation.outputs.should-deploy == 'true'

    outputs:
      build-artifact: ${{ steps.upload.outputs.artifact-id }}
      preview-version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate preview version
        id: version
        run: |
          VERSION="pr-${{ needs.quick-validation.outputs.pr-number }}-${GITHUB_SHA:0:7}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building preview version: $VERSION"

      - name: Configure preview environment
        run: |
          echo "VITE_APP_VERSION=${{ steps.version.outputs.version }}" >> apps/pwa/.env.local
          echo "VITE_APP_ENVIRONMENT=preview" >> apps/pwa/.env.local
          echo "VITE_APP_PR_NUMBER=${{ needs.quick-validation.outputs.pr-number }}" >> apps/pwa/.env.local
          echo "VITE_APP_BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> apps/pwa/.env.local
          echo "VITE_APP_COMMIT_SHA=${{ github.sha }}" >> apps/pwa/.env.local

      - name: Build preview
        run: |
          echo "Building preview for PR #${{ needs.quick-validation.outputs.pr-number }}..."
          bun run build
          
          # Add preview banner info
          echo "{
            \"version\": \"${{ steps.version.outputs.version }}\",
            \"environment\": \"preview\",
            \"prNumber\": \"${{ needs.quick-validation.outputs.pr-number }}\",
            \"buildTime\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"commitSha\": \"${{ github.sha }}\",
            \"branch\": \"${{ github.head_ref || github.ref_name }}\"
          }" > apps/pwa/dist/preview-manifest.json

      - name: Upload preview artifact
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: preview-build-pr-${{ needs.quick-validation.outputs.pr-number }}
          path: apps/pwa/dist/
          retention-days: 14

  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: [quick-validation, build-preview]

    outputs:
      preview-url: ${{ steps.deploy.outputs.preview-url }}
      netlify-url: ${{ steps.netlify.outputs.deploy-url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download preview artifact
        uses: actions/download-artifact@v4
        with:
          name: preview-build-pr-${{ needs.quick-validation.outputs.pr-number }}
          path: apps/pwa/dist/

      - name: Deploy to Vercel Preview
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: apps/pwa/dist
          alias-domains: |
            pr-${{ needs.quick-validation.outputs.pr-number }}--ninja-clan-wars.vercel.app

      - name: Deploy to Netlify Preview
        id: netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: apps/pwa/dist
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Preview for PR #${{ needs.quick-validation.outputs.pr-number }}"
          alias: pr-${{ needs.quick-validation.outputs.pr-number }}
          enable-pull-request-comment: false
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  preview-testing:
    name: Preview Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy-preview]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        run: bun x playwright install --with-deps chromium

      - name: Wait for deployment
        run: sleep 15

      - name: Test preview deployment
        run: |
          PREVIEW_URL="${{ needs.deploy-preview.outputs.preview-url }}"
          echo "Testing preview at: $PREVIEW_URL"
          
          # Basic connectivity test
          curl -f -s -I "$PREVIEW_URL" || exit 1
          echo "âœ… Preview accessibility test passed"

      - name: Run smoke tests on preview
        env:
          PLAYWRIGHT_BASE_URL: ${{ needs.deploy-preview.outputs.preview-url }}
        run: |
          # Run basic smoke tests
          if [ -d "tests/e2e/smoke" ]; then
            bun x playwright test tests/e2e/smoke --reporter=line
          else
            echo "No smoke tests found, skipping"
          fi

      - name: Performance check on preview
        run: |
          PREVIEW_URL="${{ needs.deploy-preview.outputs.preview-url }}"
          
          # Basic performance test
          START_TIME=$(date +%s%N)
          curl -f -s "$PREVIEW_URL" > /dev/null
          END_TIME=$(date +%s%N)
          
          RESPONSE_TIME=$(( (END_TIME - START_TIME) / 1000000 ))
          echo "Preview response time: ${RESPONSE_TIME}ms"
          
          if [ $RESPONSE_TIME -lt 5000 ]; then
            echo "âœ… Preview performance acceptable"
          else
            echo "âš ï¸ Preview performance warning: slow response"
          fi

  visual-regression:
    name: Visual Regression Testing
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [deploy-preview]
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        run: bun x playwright install --with-deps chromium

      - name: Visual regression tests
        env:
          PLAYWRIGHT_BASE_URL: ${{ needs.deploy-preview.outputs.preview-url }}
        run: |
          # Run visual regression tests if they exist
          if [ -d "tests/e2e/visual" ]; then
            bun x playwright test tests/e2e/visual --reporter=html
          else
            echo "Creating basic visual test..."
            mkdir -p tests/e2e/visual
            cat > tests/e2e/visual/basic.spec.js << 'EOF'
          import { test, expect } from '@playwright/test';
          
          test('homepage visual check', async ({ page }) => {
            await page.goto('/');
            await page.waitForLoadState('networkidle');
            await expect(page).toHaveScreenshot('homepage.png');
          });
          EOF
            bun x playwright test tests/e2e/visual --reporter=html || echo "Visual tests completed with differences"
          fi

      - name: Upload visual test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-test-results-pr-${{ github.event.pull_request.number }}
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  comment-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [quick-validation, build-preview, deploy-preview, preview-testing]
    if: github.event_name == 'pull_request' && always()

    steps:
      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const previewUrl = '${{ needs.deploy-preview.outputs.preview-url }}';
            const netlifyUrl = '${{ needs.deploy-preview.outputs.netlify-url }}';
            const version = '${{ needs.build-preview.outputs.preview-version }}';
            
            const testsPassed = '${{ needs.preview-testing.result }}' === 'success';
            const deploymentSuccessful = '${{ needs.deploy-preview.result }}' === 'success';
            
            let status = 'âœ… Preview deployment successful';
            if (!deploymentSuccessful) {
              status = 'âŒ Preview deployment failed';
            } else if (!testsPassed) {
              status = 'âš ï¸ Preview deployed with test warnings';
            }
            
            const body = `## ğŸš€ Preview Deployment
            
            ${status}
            
            **Version:** \`${version}\`
            **Commit:** \`${{ github.sha }}\`
            
            ### ğŸ”— Preview Links
            - **Vercel:** ${previewUrl || 'Failed to deploy'}
            - **Netlify:** ${netlifyUrl || 'Failed to deploy'}
            
            ### ğŸ“Š Deployment Details
            - **Build Status:** ${{ needs.build-preview.result === 'success' ? 'âœ… Success' : 'âŒ Failed' }}
            - **Tests Status:** ${{ needs.preview-testing.result === 'success' ? 'âœ… Passed' : needs.preview-testing.result === 'skipped' ? 'â­ï¸ Skipped' : 'âŒ Failed' }}
            - **Environment:** Preview
            
            ### ğŸ§ª Testing
            - Smoke tests: ${{ needs.preview-testing.result === 'success' ? 'Passed' : 'Check workflow for details' }}
            - Performance: Basic checks completed
            - Security: Standard preview deployment
            
            <details>
            <summary>ğŸ“‹ Deployment Manifest</summary>
            
            \`\`\`json
            {
              "version": "${version}",
              "environment": "preview",
              "prNumber": "${prNumber}",
              "commitSha": "${{ github.sha }}",
              "branch": "${{ github.head_ref }}"
            }
            \`\`\`
            </details>
            
            ---
            *This comment will be updated on new commits*`;
            
            // Look for existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const existingComment = comments.data.find(comment => 
              comment.body.includes('ğŸš€ Preview Deployment')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }

  cleanup-on-close:
    name: Cleanup Preview on PR Close
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    
    steps:
      - name: Delete preview deployments
        run: |
          echo "PR #${{ github.event.pull_request.number }} closed"
          echo "Preview deployments will be automatically cleaned up by hosting providers"
          echo "Artifacts will expire based on retention policy"

      - name: Comment cleanup notice
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.pull_request.number }},
              body: 'ğŸ§¹ **Preview Cleanup**\n\nPR closed - preview deployments are being cleaned up automatically.'
            });